name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1. Abh√§ngigkeit: Linting durchf√ºhren
  prerequisite-lint:
    uses: ./.github/workflows/lua-lint-optimized.yml
    secrets: inherit

  # 2. Abh√§ngigkeit: Tests durchf√ºhren
  prerequisite-test:
    uses: ./.github/workflows/test-release-workflow.yml
    secrets: inherit

  # 3. Eigentlicher Release (Wartet auf 1 und 2)
  release:
    needs: [prerequisite-lint, prerequisite-test]
    runs-on: 'lunexor'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create archive of resource
        run: |
          ARCHIVE_NAME="mm_megaphone-${{ github.ref_name }}.tar.gz"
          tar --exclude='.git' --exclude='.github' -czf "$ARCHIVE_NAME" .
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2.4.2
        with:
          files: ${{ env.ARCHIVE_NAME }}
          body: |
            Release ${{ github.ref_name }}
          draft: false
          prerelease: false

      # --- Notifications ---

      - name: Prepare Discord Payload
        if: always()
        id: discord_payload
        run: |
          STATUS="${{ job.status }}"
          RELEASE_URL="${{ steps.create_release.outputs.url }}"
          
          if [ "$STATUS" == "success" ]; then
            COLOR=3066993 # Green
            TITLE="üöÄ Release Ver√∂ffentlicht: ${{ github.ref_name }}"
            DESC="Qualit√§tssicherung bestanden (Lint & Test). Release erfolgreich erstellt."
            if [ -z "$RELEASE_URL" ]; then RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/releases"; fi
          else
            COLOR=15158332 # Red
            TITLE="‚ùå Release fehlgeschlagen"
            DESC="**‚ö†Ô∏è Fehler:** Der Release-Prozess ist fehlgeschlagen (siehe vorherige Schritte)."
            RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          cat <<EOF > payload.json
          {
            "username": "MM Megaphone CI/CD",
            "avatar_url": "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/github/github-original.svg",
            "embeds": [{
              "title": "$TITLE",
              "description": "$DESC",
              "color": $COLOR,
              "fields": [
                { "name": "üì¶ Archiv", "value": "\`${{ env.ARCHIVE_NAME }}\`", "inline": true },
                { "name": "üè∑Ô∏è Version", "value": "\`${{ github.ref_name }}\`", "inline": true },
                { "name": "üîó Link", "value": "[Zum Release]($RELEASE_URL)", "inline": true }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -s -F "payload_json=$(cat payload.json)" "$DISCORD_WEBHOOK"

      - name: Notify Telegram
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_API_TOKEN }}
          format: markdown
          message: |
            ${{ job.status == 'success' && 'üöÄ *Neues Release Ver√∂ffentlicht*' || '‚ùå *Release fehlgeschlagen*' }}
            
            *Version:* `${{ github.ref_name }}`
            *Status:* Lint ‚úÖ | Test ‚úÖ | Release ${{ job.status == 'success' && '‚úÖ' || '‚ùå' }}
            
            [üîó Zum Release](${{ steps.create_release.outputs.url || github.server_url }}/${{ github.repository }}/releases)