name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  ENVIRONMENT: PROD

jobs:
  # 1. Abh√§ngigkeit: Linting durchf√ºhren (Reusable Workflow)
  prerequisite-lint:
    uses: ./.github/workflows/lua-lint.yml
    secrets: inherit

  # 2. Abh√§ngigkeit: Tests durchf√ºhren (Reusable Workflow)
  prerequisite-test:
    uses: ./.github/workflows/test-release.yml
    secrets: inherit

  # 3. Eigentlicher Release (Wartet auf Lint und Test)
  release:
    needs: [prerequisite-lint, prerequisite-test]
    runs-on: 'lunexor'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Erstelle Release-Archiv mit FiveM Resource (exkludiere .git und .github)
      - name: Create archive of resource
        run: |
          ARCHIVE_NAME="mm_megaphone-${{ github.ref_name }}.tar.gz"
          
          echo "Creating release archive: $ARCHIVE_NAME"
          tar --exclude='.git' --exclude='.github' -czf "$ARCHIVE_NAME" .
          
          # Zeige Archiv-Details
          echo "Archive created successfully:"
          ls -lh "$ARCHIVE_NAME"
          
          # Speichere Archivname f√ºr sp√§tere Steps
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV

      # Erstelle GitHub Release mit Archiv als Asset
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2.4.2
        with:
          files: ${{ env.ARCHIVE_NAME }}
          body: |
            Release ${{ github.ref_name }}
          draft: false
          prerelease: false

      # --- Notifications ---

      # Discord Notification: Erstelle Payload als Datei (verhindert Escaping-Probleme)
      - name: Prepare Discord Payload
        if: always()
        id: discord_payload
        run: |
          STATUS="${{ job.status }}"
          RELEASE_URL="${{ steps.create_release.outputs.url }}"
          
          # Setze Farbe, Titel und Beschreibung basierend auf Status
          if [ "$STATUS" == "success" ]; then
            COLOR=3066993  # Gr√ºn
            TITLE="üöÄ Release Ver√∂ffentlicht: ${{ github.ref_name }}"
            DESC="Qualit√§tssicherung bestanden (Lint & Test). Release erfolgreich erstellt."
            # Fallback zur Releases-Seite, falls URL nicht verf√ºgbar
            if [ -z "$RELEASE_URL" ]; then 
              RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/releases"
            fi
          else
            COLOR=15158332  # Rot
            TITLE="‚ùå Release fehlgeschlagen"
            DESC="**‚ö†Ô∏è Fehler:** Der Release-Prozess ist fehlgeschlagen (siehe vorherige Schritte)."
            RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          # Erstelle JSON Payload in tempor√§rer Datei
          cat <<EOF > payload.json
          {
            "username": "MM Megaphone CI/CD",
            "avatar_url": "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/github/github-original.svg",
            "embeds": [{
              "title": "$TITLE",
              "description": "$DESC",
              "color": $COLOR,
              "fields": [
                { "name": "üì¶ Archiv", "value": "\\`${{ env.ARCHIVE_NAME }}\\`", "inline": true },
                { "name": "üè∑Ô∏è Version", "value": "\\`${{ github.ref_name }}\\`", "inline": true },
                { "name": "üîó Link", "value": "[Zum Release]($RELEASE_URL)", "inline": true }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Sende Payload aus Datei (verhindert Escaping-Probleme)
          curl -s -F "payload_json=$(cat payload.json)" "$DISCORD_WEBHOOK"

      - name: Notify Telegram
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_API_TOKEN }}
          format: markdown
          message: |
            ${{ job.status == 'success' && 'üöÄ *Neues Release Ver√∂ffentlicht*' || '‚ùå *Release fehlgeschlagen*' }}
            
            *Version:* `${{ github.ref_name }}`
            *Status:* Lint ‚úÖ | Test ‚úÖ | Release ${{ job.status == 'success' && '‚úÖ' || '‚ùå' }}
            
            [üîó Zum Release](${{ steps.create_release.outputs.url || format('{0}/{1}/releases', github.server_url, github.repository) }})
