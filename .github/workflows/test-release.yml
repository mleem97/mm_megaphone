name: Test Release Workflow

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  # Erlaubt den Aufruf durch andere Workflows (z.B. Release)
  workflow_call:

jobs:
  test_release_workflow:
    runs-on: lunexor

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Nutze Python 3.11 mit Pip Caching f√ºr schnellere Builds
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: python -m pip install --upgrade pip pyyaml

      # F√ºhre Workflow-Validierung durch Unit Tests
      - name: Run release.yml unit tests
        id: run_tests
        run: |
          WORKFLOW_PATH=".github/workflows/release.yml"
          python scripts/validate_release_workflow.py

      # Discord Notification: Erstelle Payload als Datei (verhindert Escaping-Probleme)
      - name: Prepare Discord Payload
        if: always()
        id: discord_payload
        run: |
          STATUS="${{ job.status }}"
          
          # Setze Farbe und Titel basierend auf Status
          if [ "$STATUS" == "success" ]; then
            COLOR=3066993  # Gr√ºn
            TITLE="‚úÖ Workflow Validierung erfolgreich"
            DESC="Das Release-Workflow-Skript wurde erfolgreich validiert."
          else
            COLOR=15158332  # Rot
            TITLE="‚ùå Workflow Validierung fehlgeschlagen"
            DESC="**‚ö†Ô∏è ACHTUNG:** Die Validierung des Release-Workflows ist gescheitert."
          fi
          
          # Erstelle JSON Payload in tempor√§rer Datei
          cat <<EOF > payload.json
          {
            "username": "MM Megaphone CI/CD",
            "avatar_url": "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/python/python-original.svg",
            "embeds": [{
              "title": "$TITLE",
              "description": "$DESC",
              "color": $COLOR,
              "fields": [
                { "name": "üìã Test", "value": "\\`validate_release_workflow.py\\`", "inline": true },
                { "name": "üè∑Ô∏è Repo / Branch", "value": "${{ github.repository }} / \\`${{ github.ref_name }}\\`", "inline": true },
                { "name": "üîó Logs", "value": "[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -s -F "payload_json=$(cat payload.json)" "$DISCORD_WEBHOOK"

      - name: Notify Telegram
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_API_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          
          # Setze Emoji basierend auf Status
          if [ "$STATUS" == "success" ]; then
            EMOJI="‚úÖ"
            STATUS_TEXT="erfolgreich"
          else
            EMOJI="‚ùå"
            STATUS_TEXT="fehlgeschlagen"
          fi
          
          # Erstelle Nachricht (URL-encoded f√ºr Telegram API)
          MESSAGE="$EMOJI *Workflow Validierung $STATUS_TEXT*%0A%0A"
          MESSAGE+="*Repo:* ${{ github.repository }}%0A"
          MESSAGE+="*Branch:* \`${{ github.ref_name }}\`%0A"
          MESSAGE+="*Test:* \`validate_release_workflow.py\`%0A%0A"
          MESSAGE+="[üîç Logs ansehen](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          # Sende via Telegram Bot API
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
               -d "chat_id=${TELEGRAM_CHAT_ID}" \
               -d "text=${MESSAGE}" \
               -d "parse_mode=Markdown" \
               -d "disable_web_page_preview=true"
