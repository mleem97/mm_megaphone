name: Lua Lint

on:
  push:
    branches:
      - '*fix*'
      - '*patch*'
      - '*update*'
      - '*upgrade*'
      - '*hotfix*'
    paths:
      - '**.lua'
      - '.luacheckrc'
      - '.github/workflows/lua-lint.yml'
  pull_request:
    branches: [main]
    paths:
      - '**.lua'
      - '.luacheckrc'
  # Erlaubt den Aufruf durch andere Workflows (z.B. Release)
  workflow_call:

env:
  ENVIRONMENT: PROD
  LUA_VERSION: "5.3"

jobs:
  lint:
    runs-on: lunexor

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Nutze offizielle Lua Actions statt apt-get
      - name: Setup Lua
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: ${{ env.LUA_VERSION }}

      - name: Setup Luarocks
        uses: leafo/gh-actions-luarocks@v4

      # Cache basierend auf .luacheckrc Hash f√ºr optimale Invalidierung
      - name: Cache LuaRocks packages
        uses: actions/cache@v4
        id: cache-luarocks
        with:
          path: ~/.luarocks
          key: ${{ runner.os }}-lua-${{ env.LUA_VERSION }}-rocks-${{ hashFiles('.luacheckrc') }}
          restore-keys: |
            ${{ runner.os }}-lua-${{ env.LUA_VERSION }}-rocks-

      - name: Install luacheck
        run: luarocks install luacheck

      # F√ºhre Luacheck aus mit strukturiertem Error Handling
      - name: Run luacheck
        id: luacheck
        run: |
          echo "Running luacheck in ${{ env.ENVIRONMENT }} environment..."
          
          # Erstelle strukturierten Report Header
          {
            echo "====================================="
            echo "LUACHECK REPORT - ${{ env.ENVIRONMENT }}"
            echo "====================================="
            echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Ref: ${{ github.ref_name }} (${GITHUB_SHA:0:7})"
            echo "Author: ${{ github.actor }}"
            echo "====================================="
            echo ""
          } > luacheck-report.txt
          
          # Exit-Code fangen, damit wir den Report generieren k√∂nnen
          set +e
          luacheck . --formatter plain --codes --ranges >> luacheck-report.txt 2>&1
          EXIT_CODE=$?
          set -e
          
          # Report Footer mit Exit Code
          {
            echo ""
            echo "====================================="
            echo "Exit Code: $EXIT_CODE"
            echo "====================================="
          } >> luacheck-report.txt
          
          # Schreibe Exit Code f√ºr sp√§tere Steps
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Extrahiere Metriken aus dem Report
          WARNINGS=$(grep -c "warning" luacheck-report.txt || echo "0")
          ERRORS=$(grep -c "error" luacheck-report.txt || echo "0")
          FILES=$(grep "Total:" luacheck-report.txt | tail -1 | awk '{print $6}' || echo "0")
          
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "files=$FILES" >> $GITHUB_OUTPUT
          
          # Erst NACH Report-Generierung mit Exit Code abbrechen
          if [ $EXIT_CODE -ne 0 ]; then
            exit $EXIT_CODE
          fi

      # Discord Notification: Erstelle Payload als Datei (verhindert Escaping-Probleme)
      - name: Prepare Discord Payload
        if: always() && env.ENVIRONMENT == 'PROD'
        id: discord_payload
        run: |
          STATUS="${{ job.status }}"
          
          # Setze Farbe und Titel basierend auf Status
          if [ "$STATUS" == "success" ]; then
            COLOR=3066993  # Gr√ºn
            TITLE="‚úÖ Lua Lint erfolgreich"
            DESC="Alle Lua-Dateien haben die Lint-Pr√ºfung bestanden"
          else
            COLOR=15158332  # Rot
            TITLE="‚ùå Lua Lint fehlgeschlagen"
            DESC="**‚ö†Ô∏è ACHTUNG:** Lint-Fehler gefunden!"
          fi
          
          # Erstelle JSON Payload in tempor√§rer Datei
          cat <<EOF > payload.json
          {
            "username": "MM Megaphone CI/CD",
            "avatar_url": "https://cdn.jsdelivr.net/gh/devicons/devicon/icons/lua/lua-original.svg",
            "embeds": [{
              "title": "$TITLE",
              "description": "$DESC",
              "color": $COLOR,
              "fields": [
                { "name": "üìä Ergebnisse", "value": "üìÅ **${{ steps.luacheck.outputs.files }}** Dateien\\n‚ö†Ô∏è **${{ steps.luacheck.outputs.warnings }}** Warnungen\\n‚ùå **${{ steps.luacheck.outputs.errors }}** Fehler", "inline": false },
                { "name": "üè∑Ô∏è Repo / Branch", "value": "${{ github.repository }} / \\`${{ github.ref_name }}\\`", "inline": true },
                { "name": "üîó Logs", "value": "[View Action](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF

      - name: Notify Discord
        if: always() && env.ENVIRONMENT == 'PROD'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Sende Payload aus Datei (verhindert Escaping-Probleme)
          curl -s -F "payload_json=$(cat payload.json)" \
               -F "files[0]=@luacheck-report.txt" \
               "$DISCORD_WEBHOOK"

      - name: Notify Telegram
        if: always() && env.ENVIRONMENT == 'PROD'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_API_TOKEN }}
          format: markdown
          message: |
            ${{ job.status == 'success' && '‚úÖ *Lua Lint erfolgreich*' || '‚ùå *Lua Lint fehlgeschlagen*' }}
            
            *Repo:* ${{ github.repository }}
            *Branch:* `${{ github.ref_name }}`
            
            üìä *Ergebnisse:*
            üìÅ ${{ steps.luacheck.outputs.files }} Dateien
            ‚ö†Ô∏è ${{ steps.luacheck.outputs.warnings }} Warnungen
            ‚ùå ${{ steps.luacheck.outputs.errors }} Fehler
            
            [üîç Logs ansehen](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      # Upload Report auch bei Fehlern (if: always())
      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: luacheck-report
          path: luacheck-report.txt
          retention-days: 14
