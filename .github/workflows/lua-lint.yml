name: Lua Lint

on:
  push:
    branches: [main]
    paths:
      - '**.lua'
      - '.luacheckrc'
      - '.github/workflows/lua-lint.yml'
  pull_request:
    branches: [main]
    paths:
      - '**.lua'
      - '.luacheckrc'

env:
  ENVIRONMENT: PROD

jobs:
  lint:
    runs-on: lunexor
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Cache luacheck installation
        id: cache-luacheck
        uses: actions/cache@v4
        with:
          path: |
            ~/.luarocks
            /usr/local/bin/luacheck
            /usr/local/share/lua
          key: ${{ runner.os }}-luacheck-${{ hashFiles('.github/workflows/lua-lint.yml') }}
          restore-keys: |
            ${{ runner.os }}-luacheck-
      
      - name: Install luacheck
        if: steps.cache-luacheck.outputs.cache-hit != 'true'
        run: |
          set -e
          
          if command -v luacheck >/dev/null 2>&1; then
            echo "luacheck already installed"
            exit 0
          fi
          
          echo "Installing luacheck..."
          
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -qq
            sudo apt-get install -y -qq lua5.3 luarocks
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y -q lua luarocks
          elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y -q lua luarocks
          else
            echo "No package manager found"
            exit 1
          fi
          
          sudo luarocks install luacheck
      
      - name: Run luacheck
        id: luacheck
        run: |
          echo "Running luacheck in ${{ env.ENVIRONMENT }} environment..."
          
          # Create report header
          {
            echo "====================================="
            echo "LUACHECK REPORT - ${{ env.ENVIRONMENT }}"
            echo "====================================="
            echo ""
            echo "Date: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Repository: ${{ github.repository }}"
            echo "Branch: ${{ github.ref_name }}"
            echo "Commit: ${GITHUB_SHA:0:7}"
            echo "Author: ${{ github.actor }}"
            echo ""
            echo "====================================="
            echo ""
          } > luacheck-report.txt
          
          # Run luacheck
          luacheck . --formatter plain --codes --ranges | tee -a luacheck-report.txt
          EXIT_CODE=${PIPESTATUS[0]}
          
          # Add footer
          {
            echo ""
            echo "====================================="
            echo "Exit Code: $EXIT_CODE"
            echo "====================================="
          } >> luacheck-report.txt
          
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
      
      - name: Parse results
        if: always()
        id: parse
        run: |
          if [ -f luacheck-report.txt ]; then
            WARNINGS=$(grep -c "warning" luacheck-report.txt 2>/dev/null || echo "0")
            ERRORS=$(grep -c "error" luacheck-report.txt 2>/dev/null || echo "0")
            TOTAL=$(grep "Total:" luacheck-report.txt | tail -1 | awk '{print $2}' || echo "0")
            FILES=$(grep "Total:" luacheck-report.txt | tail -1 | awk '{print $6}' || echo "0")
          else
            WARNINGS=0
            ERRORS=0
            TOTAL=0
            FILES=0
          fi
          
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "files=$FILES" >> $GITHUB_OUTPUT
      
      - name: Discord notification - Success
        if: success() && env.ENVIRONMENT == 'PROD'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -F "payload_json={
            \"username\": \"MM Megaphone CI/CD\",
            \"avatar_url\": \"https://cdn.jsdelivr.net/gh/devicons/devicon/icons/lua/lua-original.svg\",
            \"embeds\": [{
              \"title\": \"‚úÖ Lua Lint erfolgreich\",
              \"description\": \"Alle Lua-Dateien haben die Lint-Pr√ºfung bestanden\",
              \"color\": 3066993,
              \"fields\": [
                {
                  \"name\": \"üìä Ergebnisse\",
                  \"value\": \"üìÅ **${{ steps.parse.outputs.files }}** Dateien\\n‚ö†Ô∏è **${{ steps.parse.outputs.warnings }}** Warnungen\\n‚ùå **${{ steps.parse.outputs.errors }}** Fehler\",
                  \"inline\": false
                },
                {
                  \"name\": \"üè∑Ô∏è Repository\",
                  \"value\": \"\`${{ github.repository }}\`\",
                  \"inline\": true
                },
                {
                  \"name\": \"üåø Branch\",
                  \"value\": \"\`${{ github.ref_name }}\`\",
                  \"inline\": true
                },
                {
                  \"name\": \"üåç Environment\",
                  \"value\": \"\`${{ env.ENVIRONMENT }}\`\",
                  \"inline\": true
                }
              ],
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
            }]
          }" \
          -F "files[0]=@luacheck-report.txt" \
          "$DISCORD_WEBHOOK"
      
      - name: Discord notification - Failure
        if: failure() && env.ENVIRONMENT == 'PROD'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -F "payload_json={
            \"username\": \"MM Megaphone CI/CD\",
            \"avatar_url\": \"https://cdn.jsdelivr.net/gh/devicons/devicon/icons/lua/lua-original.svg\",
            \"embeds\": [{
              \"title\": \"‚ùå Lua Lint fehlgeschlagen\",
              \"description\": \"**‚ö†Ô∏è ACHTUNG:** Lint-Fehler gefunden!\",
              \"color\": 15158332,
              \"fields\": [
                {
                  \"name\": \"üìä Fehler√ºbersicht\",
                  \"value\": \"üìÅ **${{ steps.parse.outputs.files }}** Dateien\\n‚ö†Ô∏è **${{ steps.parse.outputs.warnings }}** Warnungen\\n‚ùå **${{ steps.parse.outputs.errors }}** Fehler\",
                  \"inline\": false
                },
                {
                  \"name\": \"üîó Logs\",
                  \"value\": \"[View Full Log](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
                  \"inline\": false
                }
              ],
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
            }]
          }" \
          -F "files[0]=@luacheck-report.txt" \
          "$DISCORD_WEBHOOK"
      
      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: luacheck-report-${{ env.ENVIRONMENT }}-${{ github.sha }}
          path: luacheck-report.txt
          retention-days: 90
